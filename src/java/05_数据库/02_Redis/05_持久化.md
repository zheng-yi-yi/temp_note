---
title: 持久化
category: Redis
order: 5
tag:
  - 内存数据库
  - NoSQL
---

## Redis 持久化

Redis 持久化（也被称为 Redis 数据快照）是指将当前内存中的数据状态在磁盘上保存下来，以便在下次重启时能够再次加载使用。

Redis 提供了两种持久化方法：RDB 和 AOF。

## RDB

### 含义

RDB（Redis DataBase）指的是在指定的时间间隔内，将内存中的数据集快照写入磁盘，也就是说 RDB 持久化会在指定的时间间隔内生成数据集的时间点快照。

这种方式提供了一个非常紧凑的数据集文件，可以用于备份、数据复制等场景。

> 注意，如果你需要尽可能减少在 Redis 服务器故障情况下可能丢失的数据，那么 RDB 可能不适合你。

### RDB的执行原理

RDB在开始时会调用 `fork` 创建一个子进程，子进程共享主进程的内存数据。

> 注意，这里的`fork`采用的是`copy-on-write`技术：
>
> - 当主进程执行**读操作**时，访问共享内存；
> - 当主进程执行**写操作**时，则会为父进程创建这个页面的一个私有副本，让父进程在子进程保存快照的同时，继续处理客户端的请求。

完成 `fork` 后，子进程会读取内存数据，将当前的数据集写入到一个临时的 RDB 文件中，当这个临时文件写入完成后，Redis 会用这个临时文件替换旧的 RDB 文件。

## AOF

### 含义

AOF（Append Only File，即追加文件），也就是说，在AOF下，Redis会记录服务器接收到的所有写操作命令，也可以看作是命令日志文件，可在服务器启动时，通过重新执行这些命令来还原数据集。

AOF默认是关闭的，需要修改配置文件来开启

默认情况下，Redis 的 AOF（Append Only File）持久化是关闭的。如果想要开启 AOF 持久化，需要修改 Redis 的配置文件 `redis.conf`。

```bash
# 是否开启AOF功能（默认是no）
appendonly yes
# AOF文件的名称
appendfilename "myappendonly.aof"
```

保存并关闭配置文件后，你需要重启 Redis 服务，新的配置才能生效。

### 记录频率

AOF命令记录的频率也是可以配置的。

通过修改 Redis 配置文件 `redis.conf`中的 `appendfsync` 参数来配置 AOF 命令记录的频率。`appendfsync` 参数有三个可选的值：

| 参数值     | 描述                                                         |
| ---------- | ------------------------------------------------------------ |
| `always`   | 每次有数据修改发生时都会写入 AOF 文件（每执行一次写命令就立即记录到AOF文件中）。 |
| `everysec` | 每秒钟同步一次，这是种折中的方案，它提供了良好的数据完整性，并且在大多数情况下也能提供良好的性能。 |
| `no`       | 让操作系统来决定何时进行同步。这种方式可能会在 Redis 崩溃时丢失最近一秒的数据，但是在某些 Linux 版本中，它可以提供和 `everysec` 类似的性能。 |

比如：

```bash
# 写命令执行完先放入AOF缓冲区，然后每隔一秒就将缓冲区的数据写入到AOF文件中
appendfsync everysec
```

### bgrewriteaof

因为是记录命令，所以 AOF文件会比RDB文件大得多。

另外，AOF 文件的更新操作是追加模式，因此对于同一条命令的多次修改，AOF 文件中可能会有多个版本。但一般情况下，只有最后一次写操作是有意义的。

比如：

```sh
set num 10
set name jack
set num 1024
```

上述命令可以重写为：

```sh
mset name jack num 1024
```

在这里，Redis提供了`bgrewriteaof` 命令，用于异步执行一个 AOF（Append Only File）文件重写操作。

当执行这个命令时，Redis 会创建一个子进程来写一个新的 AOF 文件，这个新的 AOF 文件包含了恢复当前数据集所需的最小命令集。当新的 AOF 文件写入完成后，Redis 会用这个新的 AOF 文件替换旧的 AOF 文件。

### 自动重写

Redis也会在触发阈值时自动去重写 AOF 文件。

阈值可以在 `redis.conf` 中配置：

```sh
# AOF文件比上次文件，增长超过100%时，触发重写
auto-aof-rewrite-percentage 100

# AOF文件体积达到64mb以上，就触发重写
auto-aof-rewrite-min-size 64mb
```

## RDB vs AOF

| 对比项       | RDB                                                          | AOF                                                          |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 持久化方式   | 定期生成数据集的快照。                                       | 记录每次写操作，将写操作追加到 AOF 文件的末尾。              |
| 数据完整性   | 可能会丢失最后一次快照之后的数据。                           | 只要 AOF 文件没有丢失，可以恢复所有数据。                    |
| 文件大小     | 通常比 AOF 文件小，因为它只保存数据集的快照。                | 通常比 RDB 文件大，因为它记录了所有的写操作。                |
| 宕机恢复速度 | 通常比 AOF 快，因为 RDB 文件只需要加载一次。                 | 通常比 RDB 慢，因为 AOF 文件需要逐条执行写操作。             |
| 系统资源占用 | 生成快照时，需要创建一个子进程，可能会占用大量内存。         | 每次写操作都需要写入磁盘，可能会对磁盘 I/O 产生影响。        |
| 使用场景     | 如果数据可以容忍一定程度的丢失，或者数据主要用于备份和全量复制。 | 如果需要尽可能减少数据丢失，或者数据主要用于日志和增量复制。 |

> 如果同时开启了 RDB 和 AOF，Redis 会优先使用 AOF 文件来恢复数据。

## 假如Redis的key过期了，会立即删除吗？

默认情况下，数据一旦写入Redis，除非手动删除，否则不会过期。

那如果在设置键的同时，设置一个过期时间。那么当这个时间到达时，Redis会立即删除这个键。

Redis对数据设置了有效时间，那过期之后，就需要将数据从内存中删除掉。可以按照不同的规则进行删除，这种删除规则就称为Redis的数据删除策略（过期策略）。

## 数据删除策略

数据删除策略分为两种：

1. **惰性删除**：只有当有客户端试图访问一个键时，Redis才会检查该键是否过期。如果过期，Redis会先删除这个键，然后返回一个错误。这种策略可以最大化减少CPU的使用，但是可能会导致大量过期键未被及时清理，占用大量内存。
2. **定期删除**：Redis每隔一段时间，会随机抽取一些键，检查并删除过期的键。这种策略是定时删除和惰性删除的折中方案，既可以避免大量过期键占用内存，又不会在某一时刻导致Redis阻塞。