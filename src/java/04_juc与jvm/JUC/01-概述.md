---
title: 多线程基础
category: Java
tag:
  - 多线程
order: 1
icon: uis:process
---

## 多任务

现代操作系统（如 Windows，macOS，Linux）都支持多任务处理，即它们能够同时运行多个任务。尽管CPU一次只能执行一条指令，但通过操作系统的任务调度机制，CPU可以在多个任务之间快速切换，从而给人一种似乎在同时执行多个任务的错觉。

多线程是多任务的一种特殊形式。在一个进程（任务）中，可以有多个线程，每个线程都可以被操作系统独立调度。这样，一个进程就可以同时执行多个任务，例如，一个线程处理用户输入，另一个线程处理后台任务。这可以提高应用程序的性能和响应性。

## 进程 VS 线程

进程和线程是操作系统进行任务管理的两个基本单位。进程是一个执行中的程序实例，它包含了程序运行时所需要的资源。线程是进程中的一个执行流，是操作系统调度（分配CPU时间）的基本单位。

一个进程可以包含一个或多个线程。每个线程都运行在进程的上下文中，并共享同样的系统资源。在多线程环境中，多个线程可以并发执行，这使得程序在处理用户交互、计算和网络活动等任务时更为高效。

下图展示了操作系统、进程和线程之间的关系：

```
┌──────────────────────────────────────────────┐
│               Operating System               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │Process   │  │Process   │  │Process   │    │
│  │┌────────┐│  │┌────────┐│  │┌────────┐│    │
│  ││ Thread ││  ││ Thread ││  ││ Thread ││    │
│  │└────────┘│  │└────────┘│  │└────────┘│    │
│  └──────────┘  └──────────┘  └──────────┘    │
└──────────────────────────────────────────────┘
```

在这个图示中，操作系统管理着三个进程，每个进程都有一个线程。这是最简单的情况，实际上，一个进程可以有多个线程，每个线程都可以并发执行。

多任务可以通过以下几种方式实现：

- 多进程模式：每个进程只有一个线程。
- 多线程模式：一个进程有多个线程。
- 多进程+多线程模式：每个进程有多个线程。

操作系统的任务调度器负责决定哪个线程应该何时运行，以及运行多长时间。这种调度方式通常被称为抢占式多任务，因为操作系统可以随时中断线程的执行，并将CPU时间分配给其他线程。

多进程模式的优点是稳定性高。因为每个进程都有自己独立的内存空间，一个进程崩溃不会影响其他进程。但是，创建进程的开销比创建线程大，进程间的通信（IPC）也比线程间的通信慢。

多线程模式的优点是资源消耗少，线程间的通信快。因为所有线程共享同一块内存空间，一个线程可以直接访问另一个线程的数据，这使得线程间的通信比进程间的通信快。但是，多线程模式的缺点是稳定性低。一个线程崩溃可能会导致整个进程崩溃。如果一个线程崩溃，我们希望它只影响自己，而不是整个进程，通常需要使用适当的同步机制（如互斥锁）来保护共享数据，以及使用try/catch块来捕获和处理可能出现的异常。

多进程+多线程模式结合了多进程和多线程的优点，但同时也继承了它们的缺点。这种模式的复杂度也是最高的。

## 为什么需要多线程？

多线程的主要优点是可以同时执行多个任务。这可以提高应用程序的性能和响应性。例如，一个线程可以处理用户输入，而另一个线程可以处理后台任务，如打印和保存。这样，用户就不必等待一个任务完成才能开始另一个任务。

多线程也可以更有效地使用处理器资源。在单线程应用程序中，如果线程等待某个事件（如 I/O 操作）完成，处理器可能会处于空闲状态。在多线程应用程序中，当一个线程等待时，处理器可以切换到另一个线程，从而提高处理器的利用率。

> 然而，多线程也带来了一些挑战，如线程同步和死锁问题。“和单线程相比，多线程编程的特点在于：**多线程经常需要读写共享数据，并且需要同步**。例如，播放电影时，就必须由一个线程播放视频，另一个线程播放音频，两个线程需要协调运行，否则画面和声音就不同步。因此，多线程编程的复杂度高，调试更困难。”

## Java多线程

Java语言内置了多线程支持，这使得Java程序可以并发执行多个任务。在Java中，每个线程都是通过`Thread`类的实例来表示的。你可以通过创建`Thread`类的子类并重写其`run`方法来定义线程的行为。

Java的多线程模型是其并发模型的基础，对于网络编程、数据库访问和Web开发等任务，都需要使用到多线程。因此，掌握Java的多线程编程是非常重要的。

举一个最简单的例子：

```java
class MyThread extends Thread {
    public void run() {
        System.out.println("My thread is running.");
    }
}

public class Main {
    public static void main(String[] args) {
        MyThread myThread = new MyThread();
        myThread.start();  // 启动新线程
    }
}
```

在上述代码中，我们创建了一个新的线程类`MyThread`，并重写了其`run`方法。然后在`main`方法中，我们创建了`MyThread`的一个实例，并调用其`start`方法来启动新的线程。当线程启动后，它会执行`run`方法中的代码。